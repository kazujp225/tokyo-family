# 0.8 非機能・セキュリティ・性能

## 文書情報
- **作成日**: 2025-10-20
- **対象**: Tokyo Friends iOS App (仮称)
- **バージョン**: v1.0 (MVP)
- **想定プラットフォーム**: iOS 16以上（推奨：iOS 17+）

---

## 1. 目的

本文書は、アプリケーションの**非機能要件**（パフォーマンス・セキュリティ・プライバシー・信頼性・法令順守）を定義し、ユーザー体験の基盤品質を担保します。

### 狙い
- 測定可能な性能目標値を設定（P95パーセンタイル等）
- PII保護とInstagram規約順守を技術的に実装
- ストア審査（App Store Review Guidelines）を通過する設計

【MAT参照：5. 非機能要件（NFR）】

---

## 2. パフォーマンス要件

### 2.1 起動時間

| 指標 | 目標値 | 測定条件 | 備考 |
|---|---|---|---|
| **コールドスタート** | P95 2.5秒以下 | iPhone 12相当（iOS 16） | スプラッシュ → ホーム表示 |
| **ウォームスタート** | P95 1.0秒以下 | 同上 | バックグラウンド → フォアグラウンド |

**測定方法**:
- Xcode Instruments（Time Profiler）
- アプリ起動 → `viewDidAppear` / `onAppear` までの時間

**最適化手法**:
- 初期化処理の遅延実行（LazyLoad）
- 画像の非同期読み込み（AsyncImage）
- 不要なフレームワークのインポート削減

【MAT参照：5.1. パフォーマンス】

---

### 2.2 画面表示速度

| 画面 | 目標値 | 測定条件 |
|---|---|---|
| ホーム（PG-10） | 初回表示 1.0秒以内 | キャッシュなし、ネットワーク良好 |
| 探索（PG-30） | カード表示 0.5秒以内 | 同上 |
| プロフィール編集（PG-61） | 初回表示 0.8秒以内 | 同上 |

**測定方法**:
- タップ → 画面表示完了（コンテンツ描画完了）までの時間
- Xcode Instruments（Core Animation）

**最適化手法**:
- API並列リクエスト（独立データは並行取得）
- スケルトン表示（体感速度向上）
- プリフェッチ（次画面のデータを事前取得）

---

### 2.3 スクロール・アニメーション

| 指標 | 目標値 | 測定条件 |
|---|---|---|
| **フレームレート** | 60fps（実機） | iPhone 12相当 |
| **スワイプ応答性** | 16ms以内 | タッチ → 描画更新 |

**測定方法**:
- Xcode Instruments（Core Animation FPS）
- 実機でのスクロール・スワイプ操作時のフレームレート

**最適化手法**:
- 重い処理をバックグラウンドスレッド化（DispatchQueue）
- 画像リサイズは事前処理（アップロード時）
- レイアウト再計算の最小化（SwiftUIのレンダリング最適化）

---

### 2.4 ネットワーク

| 指標 | 目標値 | 測定条件 |
|---|---|---|
| **APIレスポンス** | P95 1.5秒以内 | サーバー側含む |
| **画像読み込み** | P95 2.0秒以内 | 1MB画像、4G回線 |
| **タイムアウト** | 30秒 | URLSession設定 |

**最適化手法**:
- HTTP/2（URLSessionデフォルト）
- 画像自動圧縮（JPEG 80%品質、最大1280px）
- CDN配信（画像・静的ファイル）

【MAT参照：5.1. パフォーマンス】

---

## 3. セキュリティ要件

### 3.1 通信セキュリティ

| 項目 | 要件 | 実装方法 |
|---|---|---|
| **TLS** | TLS 1.2以上 | URLSession標準（iOS 12+でTLS 1.2必須） |
| **証明書ピンニング** | MVP非対応（将来検討） | - |
| **App Transport Security** | デフォルト有効 | Info.plist設定（例外なし） |

---

### 3.2 データ保護（保存）

#### サーバー側

| データ種別 | 暗号化方式 | 鍵管理 |
|---|---|---|
| **IGハンドル** | AES-256-GCM（フィールド暗号化） | KMS（鍵定期ローテーション90日） |
| **電話番号** | ハッシュ化（SHA-256） | - |
| **セッショントークン** | JWT（HMAC-SHA256署名） | サーバー秘密鍵（環境変数） |

#### クライアント側

| データ種別 | 保存先 | 暗号化 |
|---|---|---|
| **セッショントークン** | Keychain | OSレベル暗号化（生体認証連携可） |
| **ユーザーID** | UserDefaults | 平文（機密情報ではない） |
| **画像キャッシュ** | URLCache（ディスク） | 平文（公開データ） |

**EXIF除去**:
- 写真アップロード前にEXIF位置情報を除去（Image I/O）

【MAT参照：5.2. セキュリティ/プライバシー】

---

### 3.3 データ最小化

| 原則 | 実装 |
|---|---|
| **収集目的の明示** | 利用規約・プライバシーポリシーで開示 |
| **最小限の収集** | 生年月日の代わりに年齢帯のみ |
| **相互同意前の非露出** | IGハンドルはマッチ成立まで完全非表示 |
| **ログの匿名化** | 分析ログは匿名ID（PIIを含めない） |

---

### 3.4 端末信頼性（スパム対策）

| 技術 | 用途 | 実装 |
|---|---|---|
| **DeviceCheck** | 端末一意識別（匿名） | 初回登録時にトークン送信 |
| **App Attest** | アプリ改ざん検知 | 起動時にAssertion送信（iOS 14+） |

**ペナルティ**:
- 低信頼端末（連続作成）は作成制限
- 通報多発ユーザーは露出抑制

【MAT参照：4.1. 会員登録・認証 / 18. 運用/モデレーション】

---

### 3.5 ログ・監査

| ログ種別 | 保存期間 | アクセス権限 |
|---|---|---|
| **監査ログ**（管理者操作） | 90日 | 管理者のみ |
| **通報ログ** | 90日 | 管理者のみ |
| **分析ログ**（匿名） | 90日 | 開発・分析チーム |

**PII送信禁止**:
- IGハンドル・電話番号等はログに含めない
- 匿名ID（UUID）のみ送信

【MAT参照：5.2. セキュリティ/プライバシー / 14. 分析/ログ】

---

## 4. プライバシー要件

### 4.1 ATT（App Tracking Transparency）

| 項目 | MVP対応 |
|---|---|
| **IDFA利用** | 非対応（広告なし） |
| **ATT許諾** | 非表示（不要） |
| **トラッキング** | なし（匿名ID分析のみ） |

---

### 4.2 データ削除・エクスポート

| 機能 | SLA | 実装 |
|---|---|---|
| **アカウント削除** | 即時受付、30日後物理削除 | DELETE `/account` |
| **データエクスポート** | 7日以内にメール送付 | POST `/account/export` |

**削除対象**:
- User / Profile / Instagram / Interaction / Match / Safety / Notification

**削除除外**:
- 監査ログ（90日保持後削除）

【MAT参照：5.2. セキュリティ/プライバシー / 5.4. 法令/ストア審査対応】

---

## 5. 信頼性要件

### 5.1 可用性

| 指標 | 目標値 | 備考 |
|---|---|---|
| **Uptime** | 99.5%（MVP） | 月間ダウンタイム< 3.6時間 |
| **計画メンテナンス** | 月1回以内、深夜帯 | 事前通知（アプリ内・メール） |

---

### 5.2 障害時対応

**フェイルグレース**:
- API障害時: キャッシュデータ表示（グレーアウト表記）
- 部分障害時: 影響機能のみ制限（他機能は継続）

**再試行UI**:
- エラーバナー + 再試行ボタン
- 指数バックオフ（1s → 2s → 4s）

【MAT参照：5.3. 信頼性 / 15. エラー/オフライン設計】

---

## 6. 法令・ストア審査対応

### 6.1 18歳以上制限

| 項目 | 実装 |
|---|---|
| **年齢ゲート** | 生年月日入力 + セルフィー年齢推定 |
| **UI明示** | 利用規約に「18歳以上が対象」明記 |
| **エラー表示** | 18歳未満は「ご利用いただけません」 |

---

### 6.2 出会い系該当回避

| 項目 | 対策 |
|---|---|
| **UI文言** | 「出会い」「恋人」「デート」排除 |
| **代替文言** | 「友達づくり」「コミュニティ」基調 |
| **導線設計** | コミュニティ参加を主導線に |

---

### 6.3 個人情報保護

| 項目 | 実装 |
|---|---|
| **取得目的の明示** | プライバシーポリシーで開示 |
| **第三者提供** | なし（Instagram連携は自動操作なし） |
| **削除・開示受付** | アプリ内導線（設定 → アカウント） |

---

### 6.4 Instagram規約順守

| 禁止事項 | 対策 |
|---|---|
| **自動フォロー** | 実装しない |
| **自動DM送信** | 実装しない |
| **アカウント収集** | IGハンドルは相互同意時のみ表示 |
| **API利用** | 非利用（深いリンクのみ） |

**深いリンク**:
- `instagram://user?username={handle}`
- フォールバック: `https://instagram.com/{handle}`
- 遷移前確認ダイアログ必須

【MAT参照：5.4. 法令/ストア審査対応 / 7. Instagram連携ポリシー / 12. 文言ポリシー】

---

## 7. 受け入れ基準（AC）

### 7.1 パフォーマンス
- [ ] コールドスタート P95 2.5秒以下（iPhone 12実機で測定）
- [ ] ホーム画面初回表示 1.0秒以内（ネットワーク良好時）
- [ ] スクロール60fps維持（Instruments検証）

### 7.2 セキュリティ
- [ ] EXIF位置情報がアップロード前に除去される（メタデータ検証）
- [ ] セッショントークンがKeychain保存（iOSキーチェーン確認）
- [ ] IGハンドルがサーバー暗号化保存（DB直接確認）

### 7.3 プライバシー
- [ ] 18歳未満は登録不可（複数端末・ブラウザで検証）
- [ ] アカウント削除後は即ログアウト、再ログイン不可
- [ ] データエクスポートがJSON形式で機械可読

### 7.4 法令・ストア審査
- [ ] UI文言から「出会い」「恋人」「デート」が排除されている
- [ ] Instagram未インストール時はブラウザフォールバック
- [ ] 外部遷移前に確認ダイアログ表示

【MAT参照：16. QA/受け入れテスト】

---

## 8. Plan-MD 参照マップ

| 本文書セクション | Plan-MD 参照箇所 |
|---|---|---|
| 1. 目的 | 5. 非機能要件（NFR） |
| 2. パフォーマンス | 5.1. パフォーマンス |
| 3. セキュリティ | 5.2. セキュリティ/プライバシー、4.1、18 |
| 4. プライバシー | 5.2、5.4 |
| 5. 信頼性 | 5.3. 信頼性、15. エラー/オフライン |
| 6. 法令・ストア審査 | 5.4. 法令/ストア審査対応、7、12 |
| 7. 受け入れ基準 | 16. QA/受け入れテスト |

---

## 9. 補足

### 9.1 更新履歴
| 日付 | 変更内容 | 担当 |
|---|---|---|
| 2025-10-20 | 初版作成 | 開発・QA・セキュリティ |

---

**次に読むべき文書**: `0.9_テスト_受け入れ基準.md`（テスト戦略詳細）
