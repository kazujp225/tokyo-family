# 0.6 情報設計・データモデル

## 文書情報
- **作成日**: 2025-10-20
- **対象**: Tokyo Friends iOS App (仮称)
- **バージョン**: v1.0 (MVP)
- **想定プラットフォーム**: iOS 16以上（推奨：iOS 17+）

---

## 1. 目的

本文書は、アプリケーション内で扱う**すべてのデータエンティティ**（ユーザー・プロフィール・コミュニティ・マッチ等）の構造・ライフサイクル・制約を定義します。

### 狙い
- クライアント・サーバー間のデータ契約を明確化
- PII（個人識別情報）の暗号化・最小化ポリシーを組み込む
- データの整合性・削除・エクスポート要件を規定

【MAT参照：9. データ項目 / 5.2. セキュリティ/プライバシー】

---

## 2. データモデル原則

### P1: データ最小化
- **収集目的を明示**: 各フィールドの利用目的を文書化
- **不要データは収集しない**: 例）生年月日の代わりに年齢帯のみ

### P2: PII保護
- **暗号化保存**: IGハンドル・電話番号等はフィールド暗号化（サーバー側）
- **権限トークン**: 相互同意がない限りIGハンドルは復号化不可

### P3: 法令遵守
- **削除権**: アカウント削除時は法定期間経過後に物理削除
- **開示権**: データエクスポート機能（機械可読JSON）

【MAT参照：5.2 / 5.4 / 4.8.設定】

---

## 3. エンティティ一覧

| エンティティ | 責務 | クライアント保存 | サーバー保存 |
|---|---|---|---|
| User | ユーザー基本情報 | セッショントークン（Keychain） | 全フィールド |
| Profile | プロフィール詳細 | キャッシュ（短期） | 全フィールド |
| Instagram | IGハンドル（暗号化） | なし | 暗号化保存 |
| Community | コミュニティ情報 | キャッシュ（短期） | 全フィールド |
| Interaction | Like/Skip履歴 | なし | 全フィールド |
| Match | マッチ成立情報 | キャッシュ（短期） | 全フィールド |
| Safety | ブロック・通報履歴 | なし | 全フィールド |
| Notification | 通知イベント | 既読状態（短期） | 全フィールド |

---

## 4. エンティティ詳細仕様

---

## E-01: User（ユーザー）

### 目的
ユーザーの基本情報と信頼性スコアを管理

### フィールド

| フィールド名 | 型 | 必須 | 説明 | 暗号化 |
|---|---|---|---|---|
| `id` | UUID | ○ | ユーザー一意識別子 | - |
| `created_at` | Timestamp | ○ | 作成日時（UTC） | - |
| `last_active_at` | Timestamp | ○ | 最終活動日時 | - |
| `trust_score` | Float | ○ | 信頼スコア（0.0〜1.0） | - |
| `auth_method` | Enum | ○ | 認証方法（phone / apple） | - |
| `phone_hash` | String | △ | 電話番号ハッシュ（重複検知用） | ハッシュ化 |
| `apple_id` | String | △ | AppleユーザーID | - |
| `device_check_token` | String | △ | DeviceCheckトークン | - |
| `status` | Enum | ○ | アカウント状態（active / suspended / deleted） | - |

### 制約
- `id`はUUIDv4（衝突回避）
- `trust_score`は通報・ブロック受信で減少、正常利用で徐々に回復
- `phone_hash`と`apple_id`の少なくとも一方は必須

### ライフサイクル
1. **作成**: 認証成功時（POST `/auth/verify` or `/auth/apple`）
2. **更新**: 最終活動日時は各API呼び出し時に自動更新
3. **削除**: アカウント削除時に`status = deleted`、法定期間経過後に物理削除

### クライアント保存
- **セッショントークン**: Keychain（有効期限付き、再認証で更新）
- **ユーザーID**: UserDefaults（キャッシュ目的）

【MAT参照：9. データ項目 / 4.1. 会員登録・認証】

---

## E-02: Profile（プロフィール）

### 目的
ユーザーの自己情報・興味を管理

### フィールド

| フィールド名 | 型 | 必須 | 説明 | 公開範囲 |
|---|---|---|---|---|
| `user_id` | UUID | ○ | ユーザーID（外部キー） | - |
| `age_range` | Enum | ○ | 年齢帯（18–19 / 20–22 / 23–25 / 26+） | 全ユーザー |
| `attribute` | Enum | ○ | 属性（student / worker） | 全ユーザー |
| `school_or_work` | String | ○ | 学校名 or 勤務形態 | 全ユーザー |
| `district` | String | ○ | 居住区（例: 新宿区） | 全ユーザー |
| `nearest_station` | String | ○ | 最寄駅（例: 新宿駅） | 全ユーザー |
| `interests` | Array<String> | ○ | 興味タグ（3〜10個） | 全ユーザー |
| `bio` | String | △ | 自己紹介（最大300文字） | 全ユーザー |
| `photos` | Array<String> | △ | 写真URL（最大5枚） | 全ユーザー |
| `photo_order` | Array<Int> | △ | 写真表示順序 | - |

### 制約
- `interests`は3〜10個（バリデーション: クライアント＋サーバー）
- `bio`は最大300文字、禁止ワード検出（性的表現・連絡先等）
- `photos`は最大5枚、ファイルサイズ上限10MB、EXIF除去

### ライフサイクル
1. **作成**: オンボーディング完了時（POST `/me`）
2. **更新**: プロフィール編集時（PUT `/me`）
3. **削除**: アカウント削除時に同時削除

### クライアント保存
- **キャッシュ**: 自分のプロフィールは短期キャッシュ（24時間）
- **画像**: URLCache（標準キャッシュ戦略）

【MAT参照：9. データ項目 / 4.2. オンボーディング／プロフィール】

---

## E-03: Instagram（IGハンドル）

### 目的
IGハンドルの暗号化保存と権限制御

### フィールド

| フィールド名 | 型 | 必須 | 説明 | 暗号化 |
|---|---|---|---|---|
| `user_id` | UUID | ○ | ユーザーID（外部キー） | - |
| `handle_encrypted` | String | △ | 暗号化IGハンドル | ○（フィールド暗号化） |
| `encryption_key_id` | String | △ | KMS鍵ID | - |
| `visibility` | Enum | ○ | 可視性（hidden / revealed） | - |
| `revealed_to` | Array<UUID> | △ | 公開先ユーザーID（マッチ成立時） | - |

### 制約
- `handle_encrypted`はAES-256-GCMで暗号化
- 復号化は`revealed_to`に含まれるユーザーのみ可能（サーバー側で検証）
- 鍵はKMS管理、定期ローテーション（90日）

### ライフサイクル
1. **作成**: IGハンドル登録時（PUT `/me/instagram`）
2. **更新**: IGハンドル変更時
3. **削除**: アカウント削除時に同時削除

### クライアント保存
- **なし**（相互同意後のみ平文で取得、メモリ内で保持）

【MAT参照：9. データ項目 / 5.2. セキュリティ/プライバシー / 7. Instagram連携ポリシー】

---

## E-04: Community（コミュニティ）

### 目的
区×興味のコミュニティ情報を管理

### フィールド

| フィールド名 | 型 | 必須 | 説明 |
|---|---|---|---|
| `id` | UUID | ○ | コミュニティ一意識別子 |
| `name` | String | ○ | 名称（例: 新宿×カフェ） |
| `district` | String | ○ | 区（例: 新宿区） |
| `interest_tag` | String | ○ | 興味タグ（例: カフェ） |
| `participant_count` | Int | ○ | 参加者数 |
| `thumbnail_url` | String | △ | サムネイル画像URL |
| `description` | String | △ | 説明文 |
| `created_at` | Timestamp | ○ | 作成日時 |

### 制約
- `name`は`district` + `×` + `interest_tag`で自動生成
- `participant_count`はリアルタイム更新（参加/退出時）

### ライフサイクル
1. **作成**: 運営側で手動作成（MVP）
2. **更新**: 参加者数は自動更新
3. **削除**: 運営判断で削除（参加者へ通知）

### クライアント保存
- **キャッシュ**: 一覧は短期キャッシュ（1時間）

【MAT参照：9. データ項目 / 4.3. コミュニティ】

---

## E-05: Interaction（インタラクション）

### 目的
Like/Skip履歴の管理とレート制限

### フィールド

| フィールド名 | 型 | 必須 | 説明 |
|---|---|---|---|
| `id` | UUID | ○ | インタラクション一意識別子 |
| `from_user_id` | UUID | ○ | 送信元ユーザーID |
| `to_user_id` | UUID | ○ | 送信先ユーザーID |
| `type` | Enum | ○ | 種別（like / skip） |
| `created_at` | Timestamp | ○ | 作成日時 |
| `context` | JSON | △ | コンテキスト（コミュニティID等） |

### 制約
- 同一ペア（`from_user_id`, `to_user_id`）は1回のみ（UNIQUE制約）
- レート制限: 1時間あたり50件まで（`from_user_id`単位）

### ライフサイクル
1. **作成**: Like/Skip時（POST `/interactions/like` or `/interactions/skip`）
2. **更新**: なし（不変）
3. **削除**: アカウント削除時に同時削除

### クライアント保存
- **なし**（サーバー側のみ）

【MAT参照：9. データ項目 / 4.4. カード探索】

---

## E-06: Match（マッチ）

### 目的
マッチ成立情報とIGハンドル参照権限を管理

### フィールド

| フィールド名 | 型 | 必須 | 説明 |
|---|---|---|---|
| `id` | UUID | ○ | マッチ一意識別子 |
| `user_a_id` | UUID | ○ | ユーザーA ID |
| `user_b_id` | UUID | ○ | ユーザーB ID |
| `matched_at` | Timestamp | ○ | 成立日時 |
| `ig_access_token` | String | ○ | IGハンドル参照トークン（有効期限付き） |
| `status` | Enum | ○ | 状態（active / blocked_by_a / blocked_by_b） |

### 制約
- ペア（`user_a_id`, `user_b_id`）はUNIQUE（重複マッチ防止）
- 片方がブロックした場合、`status`を更新し、IGハンドル非表示

### ライフサイクル
1. **作成**: 相互同意成立時（POST `/interactions/like`がマッチ検出）
2. **更新**: ブロック時に`status`更新
3. **削除**: アカウント削除時に同時削除

### クライアント保存
- **キャッシュ**: マッチ一覧は短期キャッシュ（1時間）
- **IGハンドル**: メモリ内のみ（永続化しない）

【MAT参照：9. データ項目 / 4.5. マッチング】

---

## E-07: Safety（安全）

### 目的
ブロック・通報履歴の管理と監査ログ

### フィールド（ブロック）

| フィールド名 | 型 | 必須 | 説明 |
|---|---|---|---|
| `id` | UUID | ○ | ブロック一意識別子 |
| `from_user_id` | UUID | ○ | ブロック実行者ID |
| `to_user_id` | UUID | ○ | ブロック対象ID |
| `reason` | String | △ | 理由（任意） |
| `created_at` | Timestamp | ○ | ブロック日時 |

### フィールド（通報）

| フィールド名 | 型 | 必須 | 説明 |
|---|---|---|---|
| `id` | UUID | ○ | 通報一意識別子 |
| `from_user_id` | UUID | ○ | 通報者ID |
| `to_user_id` | UUID | ○ | 通報対象ID |
| `reason` | Enum | ○ | 理由（spam / impersonation / harassment / inappropriate_image / underage / other） |
| `detail` | String | △ | 詳細（任意自由入力） |
| `created_at` | Timestamp | ○ | 通報日時 |
| `status` | Enum | ○ | 対応状態（pending / under_review / resolved） |

### 制約
- ブロックはUNIQUE（同一ペアは1回のみ）
- 通報は重複可能（連続通報も記録）
- 監査ログは管理者のみアクセス、一定期間（90日）で自動削除

### ライフサイクル
1. **作成**: ブロック/通報時（POST `/safety/block` or `/safety/report`）
2. **更新**: 通報の`status`は運営側で更新
3. **削除**: ブロック解除時に削除、通報は保持（監査目的）

### クライアント保存
- **なし**（サーバー側のみ）

【MAT参照：9. データ項目 / 4.6. 安全 / 18. 運用/モデレーション】

---

## E-08: Notification（通知）

### 目的
通知イベントの管理と既読状態の追跡

### フィールド

| フィールド名 | 型 | 必須 | 説明 |
|---|---|---|---|
| `id` | UUID | ○ | 通知一意識別子 |
| `user_id` | UUID | ○ | 受信者ID |
| `type` | Enum | ○ | 種別（match / community_new / announcement） |
| `title` | String | ○ | タイトル |
| `body` | String | ○ | 本文 |
| `deep_link` | String | △ | Deep LinkターゲットURL |
| `created_at` | Timestamp | ○ | 作成日時 |
| `read_at` | Timestamp | △ | 既読日時 |

### 制約
- `type`ごとに頻度制限（例: `community_new`は週3件まで）

### ライフサイクル
1. **作成**: イベント発火時（マッチ成立・コミュニティ追加等）
2. **更新**: 既読時に`read_at`を更新（PUT `/notifications/{id}/read`）
3. **削除**: 30日経過で自動削除

### クライアント保存
- **既読状態**: UserDefaults（短期キャッシュ）

【MAT参照：9. データ項目 / 4.7. 通知 / 11. 通知仕様】

---

## 5. API契約（データ交換形式）

### 5.1 共通フォーマット

**成功レスポンス**:
```
{
  "status": "success",
  "data": { ... }
}
```

**エラーレスポンス**:
```
{
  "status": "error",
  "code": "VALIDATION_ERROR",
  "message": "興味タグは3個以上選択してください",
  "details": { ... }
}
```

**レート制限ヘッダ**:
```
X-RateLimit-Limit: 50
X-RateLimit-Remaining: 32
X-RateLimit-Reset: 1640995200
```

【MAT参照：8. API設計 / 8.6. エラー/レート制限】

---

### 5.2 主要エンドポイント

#### GET `/me`（自分のプロフィール取得）
**レスポンス**:
```
{
  "status": "success",
  "data": {
    "user_id": "uuid",
    "age_range": "20-22",
    "attribute": "student",
    "school_or_work": "東京大学",
    "district": "新宿区",
    "nearest_station": "新宿駅",
    "interests": ["カフェ", "サウナ", "写真"],
    "bio": "週末カフェ巡りが好きです",
    "photos": ["url1", "url2"]
  }
}
```

#### GET `/feed`（カード取得）
**クエリパラメータ**:
- `community_id` (UUID): コミュニティフィルタ
- `age_range` (String): 年齢帯フィルタ
- `limit` (Int): 取得件数（デフォルト: 20）
- `offset` (Int): ページング

**レスポンス**:
```
{
  "status": "success",
  "data": {
    "cards": [
      {
        "user_id": "uuid",
        "age_range": "20-22",
        "attribute": "student",
        "interests": ["カフェ", "サウナ"],
        "bio": "...",
        "photos": ["url1"]
      }
    ],
    "has_more": true
  }
}
```

#### POST `/interactions/like`
**リクエスト**:
```
{
  "to_user_id": "uuid"
}
```

**レスポンス**:
```
{
  "status": "success",
  "data": {
    "matched": true,
    "ig_access_token": "token_abc123"
  }
}
```

【MAT参照：8. API設計】

---

## 6. データ削除・エクスポート

### 6.1 アカウント削除

**処理フロー**:
1. DELETE `/account` → 即時受付
2. `User.status = deleted`
3. 即時ログアウト（セッショントークン無効化）
4. 法定期間（30日）経過後に物理削除（バッチ処理）

**削除対象**:
- User / Profile / Instagram / Interaction / Match / Safety / Notification

**削除除外**:
- 監査ログ（90日保持後削除）

### 6.2 データエクスポート

**処理フロー**:
1. POST `/account/export` → エクスポート要求
2. サーバー側でJSON生成（非同期）
3. 完了後メールでダウンロードリンク送付（有効期限: 7日）

**エクスポートデータ**:
- プロフィール情報
- コミュニティ参加履歴
- マッチ履歴（IGハンドルは暗号化）
- ブロック/通報履歴

【MAT参照：4.8. 設定 / 5.4. 法令/ストア審査対応】

---

## 7. Plan-MD 参照マップ

| 本文書セクション | Plan-MD 参照箇所 |
|---|---|---|
| 1. 目的 | 9. データ項目 |
| 2. データモデル原則 | 5.2. セキュリティ/プライバシー、5.4. 法令/ストア審査対応 |
| 3. エンティティ一覧 | 9. データ項目 |
| E-01: User | 9. データ項目、4.1. 会員登録・認証 |
| E-02: Profile | 9. データ項目、4.2. オンボーディング／プロフィール |
| E-03: Instagram | 9. データ項目、5.2、7. Instagram連携ポリシー |
| E-04: Community | 9. データ項目、4.3. コミュニティ |
| E-05: Interaction | 9. データ項目、4.4. カード探索 |
| E-06: Match | 9. データ項目、4.5. マッチング |
| E-07: Safety | 9. データ項目、4.6. 安全、18. 運用/モデレーション |
| E-08: Notification | 9. データ項目、4.7. 通知、11. 通知仕様 |
| 5. API契約 | 8. API設計、8.6. エラー/レート制限 |
| 6. データ削除・エクスポート | 4.8. 設定、5.4. 法令/ストア審査対応 |

---

## 8. 補足

### 8.1 更新履歴
| 日付 | 変更内容 | 担当 |
|---|---|---|
| 2025-10-20 | 初版作成 | 開発・データ |

---

**次に読むべき文書**: `0.7_アーキテクチャ_状態管理.md`（クライアント技術詳細）
