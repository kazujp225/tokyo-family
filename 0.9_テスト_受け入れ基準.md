# 0.9 テスト・受け入れ基準

## 文書情報
- **作成日**: 2025-10-20
- **対象**: Tokyo Friends iOS App (仮称)
- **バージョン**: v1.0 (MVP)
- **想定プラットフォーム**: iOS 16以上（推奨：iOS 17+）

---

## 1. 目的

本文書は、アプリケーションの**品質保証**（QA）のためのテスト戦略・テスト項目・受け入れ基準を定義します。

### 狙い
- 機能テスト・非機能テスト・セキュリティテストの網羅的な実施
- リリース判定基準の明確化（不具合優先度別の許容値）
- 自動化可能な領域と手動テスト領域の区分

【MAT参照：16. QA/受け入れテスト】

---

## 2. テスト戦略

### 2.1 テストピラミッド

```
       ┌─────────────┐
       │   Manual    │  手動（UI/E2E）
       │   (10%)     │
       ├─────────────┤
       │ Integration │  統合（API）
       │   (30%)     │
       ├─────────────┤
       │   Unit      │  単体（ViewModel/UseCase）
       │   (60%)     │
       └─────────────┘
```

**方針**:
- 単体テスト60%: ビジネスロジック（ViewModel / UseCase）
- 統合テスト30%: API通信・Repository
- 手動テスト10%: UI/UX・アクセシビリティ・実機検証

---

### 2.2 自動化スコープ

| テスト種別 | 自動化 | 理由 |
|---|---|---|
| 単体テスト（Unit） | ○ | XCTest + Mock |
| 統合テスト（Integration） | ○ | URLProtocol Mock |
| UIテスト（UI） | △ | XCUITest（重要フローのみ） |
| 手動テスト（Manual） | × | アクセシビリティ・実機体感 |

---

## 3. テスト項目

---

## 3.1 機能テスト

### T-01: 会員登録・年齢ゲート

#### 目的
18歳未満の排除と認証フローの正常動作を確認

#### テストケース

| ID | ケース | 期待結果 | 優先度 |
|---|---|---|---|
| T-01-01 | 電話番号でログイン成功 | SMS受信 → コード入力 → セッショントークン取得 | 必須 |
| T-01-02 | Appleでサインイン成功 | Appleトークン検証 → セッショントークン取得 | 必須 |
| T-01-03 | SMSコード不一致 | エラー表示「コードが正しくありません」 | 必須 |
| T-01-04 | 18歳未満で登録試行 | ブロック画面「ご利用いただけません」 | 必須 |
| T-01-05 | 18歳以上で登録成功 | オンボーディングへ遷移 | 必須 |
| T-01-06 | 規約未同意で次へ | 次へボタン非活性 | 必須 |

【MAT参照：4.1. 会員登録・認証】

---

### T-02: オンボーディング

#### 目的
プロフィール作成フローの正常動作とバリデーションを確認

#### テストケース

| ID | ケース | 期待結果 | 優先度 |
|---|---|---|---|
| T-02-01 | 必須項目未入力で次へ | エラー表示「○○を入力してください」 | 必須 |
| T-02-02 | 興味タグ3未満 | エラー表示「最低3つ選択してください」 | 必須 |
| T-02-03 | 写真0枚で進行 | 正常に完了（写真任意） | 必須 |
| T-02-04 | EXIF除去検証 | アップロード画像にGPS情報なし | 必須 |
| T-02-05 | 禁止ワード検出 | エラー表示「不適切な内容が含まれています」 | 必須 |
| T-02-06 | IGハンドル登録 | サーバー暗号化フラグ受領 | 必須 |

【MAT参照：4.2. オンボーディング／プロフィール】

---

### T-03: コミュニティ参加

#### 目的
コミュニティ参加/退出の即時反映を確認

#### テストケース

| ID | ケース | 期待結果 | 優先度 |
|---|---|---|---|
| T-03-01 | コミュニティ参加 | 参加成功 → 探索で当該コミュニティのカード優先表示 | 必須 |
| T-03-02 | コミュニティ退出 | 退出成功 → 探索で当該コミュニティのカード非表示 | 必須 |
| T-03-03 | フィルタ変更 | 300ms以内で結果更新 | 推奨 |

【MAT参照：4.3. コミュニティ】

---

### T-04: カード探索・スワイプ

#### 目的
スワイプ操作とマッチ成立の正常動作を確認

#### テストケース

| ID | ケース | 期待結果 | 優先度 |
|---|---|---|---|
| T-04-01 | 右スワイプ（Like） | カード右へ飛び出し → 次カード表示 | 必須 |
| T-04-02 | 左スワイプ（Skip） | カード左へ飛び出し → 次カード表示 | 必須 |
| T-04-03 | レート制限超過 | クールダウンメッセージ表示 | 必須 |
| T-04-04 | 在庫切れ | 「コミュニティ追加」提案カード表示 | 必須 |
| T-04-05 | スキップ済み再出現 | 当日は再出現しない | 推奨 |

【MAT参照：4.4. カード探索】

---

### T-05: マッチング・IGハンドル解錠

#### 目的
相互同意のみでIGハンドル表示を確認

#### テストケース

| ID | ケース | 期待結果 | 優先度 |
|---|---|---|---|
| T-05-01 | 相互同意成立 | 半モーダル表示 → IGハンドル可視化 | 必須 |
| T-05-02 | 片側のみLike | IGハンドル非表示 | 必須 |
| T-05-03 | 片方がブロック | IGハンドル表示無効化 + ボタン無効 | 必須 |
| T-05-04 | Instagram深いリンク | 確認ダイアログ → Instagramアプリ起動 | 必須 |
| T-05-05 | Instagram未インストール | ブラウザにフォールバック | 必須 |
| T-05-06 | プッシュ通知 | 「マッチが成立しました」→ タップで詳細へ | 推奨 |

【MAT参照：4.5. マッチング / 7. Instagram連携ポリシー】

---

### T-06: 安全機能（ブロック・通報・非表示）

#### 目的
安全操作の即時反映と監査ログ記録を確認

#### テストケース

| ID | ケース | 期待結果 | 優先度 |
|---|---|---|---|
| T-06-01 | ブロック実行 | 1秒以内に不可視化（カード/マッチ/通知） | 必須 |
| T-06-02 | 通報送信 | 3秒以内にトースト表示「通報を受け付けました」 | 必須 |
| T-06-03 | 通報理由未選択 | エラー表示「理由を選択してください」 | 必須 |
| T-06-04 | ブロック解除 | 確認ダイアログ → 解除成功 | 推奨 |
| T-06-05 | 監査ログ記録 | サーバー側で通報ログ保存（管理者確認） | 推奨 |

【MAT参照：4.6. 安全 / 18. 運用/モデレーション】

---

### T-07: 設定・アカウント管理

#### 目的
データエクスポート・削除の法令遵守を確認

#### テストケース

| ID | ケース | 期待結果 | 優先度 |
|---|---|---|---|
| T-07-01 | データエクスポート要求 | 7日以内にメール送付（JSON形式） | 必須 |
| T-07-02 | アカウント削除 | 即ログアウト → 再ログイン不可 | 必須 |
| T-07-03 | 削除確認ダイアログ | 2段階確認（警告 → 生体認証） | 必須 |
| T-07-04 | 物理削除 | 30日後にDB削除（バッチ処理確認） | 推奨 |

【MAT参照：4.8. 設定 / 5.4. 法令/ストア審査対応】

---

## 3.2 非機能テスト

### T-10: パフォーマンス

| ID | 項目 | 目標値 | 測定方法 |
|---|---|---|---|
| T-10-01 | コールドスタート | P95 2.5秒以下 | Instruments（Time Profiler） |
| T-10-02 | ホーム初回表示 | 1.0秒以内 | タップ → 表示完了時間 |
| T-10-03 | スクロール60fps | フレームレート安定 | Instruments（Core Animation） |
| T-10-04 | API応答 | P95 1.5秒以内 | ネットワークモニタ |

【MAT参照：5.1. パフォーマンス】

---

### T-11: セキュリティ

| ID | 項目 | 検証方法 | 優先度 |
|---|---|---|---|
| T-11-01 | EXIF除去 | 画像メタデータ検証（ExifTool） | 必須 |
| T-11-02 | セッショントークン暗号化 | Keychain保存確認（iOSキーチェーン） | 必須 |
| T-11-03 | IGハンドル暗号化 | DB直接確認（平文非保存） | 必須 |
| T-11-04 | TLS 1.2以上 | Charles Proxy / Wireshark | 必須 |
| T-11-05 | DeviceCheck動作 | 低信頼端末の作成制限確認 | 推奨 |

【MAT参照：5.2. セキュリティ/プライバシー】

---

### T-12: アクセシビリティ

| ID | 項目 | 検証方法 | 優先度 |
|---|---|---|---|
| T-12-01 | VoiceOver操作 | 全フロー操作可能（実機検証） | 必須 |
| T-12-02 | Dynamic Type | 最大/最小サイズで崩れなし | 必須 |
| T-12-03 | コントラスト | AA以上（主要文言）、WebAIM検証 | 必須 |
| T-12-04 | タップ領域 | 44×44pt以上（実機検証） | 必須 |
| T-12-05 | Reduce Motion | パララックス無効化 | 推奨 |

【MAT参照：13. アクセシビリティ / デザイン定義 6】

---

### T-13: オフライン・エラー

| ID | ケース | 期待結果 | 優先度 |
|---|---|---|---|
| T-13-01 | ネットワーク不通 | 「インターネット接続を確認してください」バナー | 必須 |
| T-13-02 | API障害 | キャッシュデータ表示（グレーアウト） | 必須 |
| T-13-03 | タイムアウト（30秒） | 再試行ボタン表示 | 必須 |
| T-13-04 | レート制限（429） | 指数バックオフ（1s → 2s → 4s） | 推奨 |

【MAT参照：15. エラー/オフライン設計】

---

## 4. 受け入れ基準（リリース判定）

### 4.1 不具合優先度別の許容値

| 優先度 | 定義 | リリース判定 |
|---|---|---|
| **P0 致命的** | アプリクラッシュ、データ消失、18歳未満登録可能 | 0件必須 |
| **P1 重大** | 主要機能不全（マッチ成立しない等） | 0件必須 |
| **P2 中** | 一部機能不全（検索失敗等） | 3件以下許容 |
| **P3 軽微** | UI崩れ、文言誤り | 10件以下許容 |

---

### 4.2 必須テスト項目（リリース前）

#### 機能テスト
- [ ] T-01: 会員登録・年齢ゲート（全ケース）
- [ ] T-02: オンボーディング（全ケース）
- [ ] T-04: カード探索（主要ケース）
- [ ] T-05: マッチング（全ケース）
- [ ] T-06: ブロック・通報（主要ケース）
- [ ] T-07: アカウント削除・エクスポート（全ケース）

#### 非機能テスト
- [ ] T-10: パフォーマンス（全項目）
- [ ] T-11: セキュリティ（全項目）
- [ ] T-12: アクセシビリティ（VoiceOver / Dynamic Type / コントラスト）
- [ ] T-13: オフライン・エラー（主要ケース）

#### 実機検証
- [ ] iPhone 12（iOS 16）
- [ ] iPhone 14 Pro（iOS 17）
- [ ] ライトモード・ダークモード
- [ ] 最小/最大Dynamic Typeサイズ

【MAT参照：16. QA/受け入れテスト】

---

## 5. テスト環境

### 5.1 開発・ステージング・本番

| 環境 | 用途 | データ |
|---|---|---|
| **Development** | 開発・単体テスト | ダミーデータ |
| **Staging** | 統合・E2Eテスト | 本番相当データ（匿名化） |
| **Production** | 本番 | 実データ |

---

### 5.2 テストデータ

**ダミーユーザー**:
- 18歳以上ユーザー（10名）
- 18歳未満ユーザー（2名、登録不可確認用）
- コミュニティ参加済みユーザー（5名）

**ダミーコミュニティ**:
- 新宿×カフェ（参加者: 100名）
- 新宿×サウナ（参加者: 50名）
- 渋谷×音楽（参加者: 80名）

---

## 6. 自動テスト実装例

### 6.1 単体テスト（Unit Test）

```swift
// ExploreViewModelTests.swift
class ExploreViewModelTests: XCTestCase {
  func testLoadCards_Success() async throws {
    // Arrange
    let mockUseCase = MockFetchCardsUseCase()
    mockUseCase.stubbedCards = [
      CardModel(userId: UUID(), ageRange: "20-22", bio: "Test")
    ]
    let viewModel = ExploreViewModel(fetchCardsUseCase: mockUseCase)

    // Act
    await viewModel.loadCards()

    // Assert
    XCTAssertEqual(viewModel.cards.count, 1)
    XCTAssertFalse(viewModel.isLoading)
    XCTAssertNil(viewModel.errorMessage)
  }

  func testLoadCards_Failure() async throws {
    // Arrange
    let mockUseCase = MockFetchCardsUseCase()
    mockUseCase.stubbedError = NetworkError.networkUnavailable
    let viewModel = ExploreViewModel(fetchCardsUseCase: mockUseCase)

    // Act
    await viewModel.loadCards()

    // Assert
    XCTAssertEqual(viewModel.cards.count, 0)
    XCTAssertFalse(viewModel.isLoading)
    XCTAssertNotNil(viewModel.errorMessage)
  }
}
```

---

### 6.2 UIテスト（UI Test）

```swift
// LoginUITests.swift
class LoginUITests: XCTestCase {
  func testPhoneLogin_Success() throws {
    let app = XCUIApplication()
    app.launch()

    // 電話番号ログインボタンタップ
    app.buttons["電話番号でログイン"].tap()

    // 電話番号入力
    let phoneField = app.textFields["電話番号"]
    phoneField.tap()
    phoneField.typeText("09012345678")

    // 次へボタンタップ
    app.buttons["次へ"].tap()

    // SMSコード入力
    let codeField = app.textFields["SMSコード"]
    XCTAssertTrue(codeField.waitForExistence(timeout: 5))
    codeField.tap()
    codeField.typeText("123456")

    // ホーム画面遷移確認
    XCTAssertTrue(app.staticTexts["ホーム"].waitForExistence(timeout: 5))
  }
}
```

---

## 7. Plan-MD 参照マップ

| 本文書セクション | Plan-MD 参照箇所 |
|---|---|---|
| 1. 目的 | 16. QA/受け入れテスト |
| 3.1 機能テスト | 4. 主要機能要件全般 |
| 3.2 非機能テスト | 5. 非機能要件、13. アクセシビリティ、15. エラー/オフライン |
| 4. 受け入れ基準 | 16. QA/受け入れテスト |

---

## 8. 補足

### 8.1 更新履歴
| 日付 | 変更内容 | 担当 |
|---|---|---|
| 2025-10-20 | 初版作成 | QA・開発 |

---

**次に読むべき文書**: `0.10_運用_分析_配信_法務.md`（運用・リリース詳細）
