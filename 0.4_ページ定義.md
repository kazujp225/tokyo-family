# 0.4 ページ定義

## 文書情報
- **作成日**: 2025-10-20
- **対象**: Tokyo Friends iOS App (仮称)
- **バージョン**: v1.0 (MVP)
- **想定プラットフォーム**: iOS 16以上（推奨：iOS 17+）

---

## 1. 目的

本文書は、アプリケーション内の**すべての画面（ページ）**について、目的・入出口・UI構成・状態・計測・アクセシビリティ・受け入れ基準を網羅的に定義します。

### 狙い
- 画面ごとの責務を明確化し、機能の重複・漏れを防ぐ
- 開発・デザイン・QA間で実装範囲を共有
- 遷移フローと計測イベントを可視化

【MAT参照：ページ定義全般 / 6.2. 画面一覧と要件】

---

## 2. グローバル前提

### 2.1 ナビゲーション構造

**タブバー（最下部、5タブ）**:
1. **ホーム**: `house`（SF Symbol）
2. **コミュニティ**: `person.2`
3. **探索**: `sparkles`
4. **マッチ**: `heart.text.square`
5. **プロフィール**: `person.crop.circle`

**ナビゲーションバー**:
- Large Title → スクロールで小タイトルへ縮小
- 右側: 通知（`bell` + バッジドット）、検索（`magnifyingglass`）、アバター（円形24〜28pt）

### 2.2 共通UI要件

- **言語**: 日本語（ja-JP）
- **テーマ**: ライト/ダーク対応（Semantic Colors）
- **アクセシビリティ**: Dynamic Type、VoiceOver、コントラストAA以上
- **ハプティクス**: 成功 = `notificationSuccess`、エラー = `notificationError`、軽操作 = `impactLight`

【MAT参照：ページ定義 0.グローバル前提 / デザイン定義 2.配色】

---

## 3. ページ一覧（ID順）

| ID | ページ名 | 主な目的 | 入口 | 出口 |
|---|---|---|---|---|
| PG-01 | スプラッシュ | セッション確認・初期化 | アプリ起動 | ログイン / ホーム |
| PG-02 | ログイン | 認証と規約同意 | PG-01 | 年齢確認 / ホーム |
| PG-03 | 年齢確認 | 18歳以上ゲート | PG-02 | オンボーディング / ブロック |
| PG-04 | 権限リクエスト | 通知・写真の許可説明 | PG-05途中 | 次セクション |
| PG-05 | オンボーディング：基本属性 | 居住区・最寄駅・属性 | PG-03 | PG-06 |
| PG-06 | オンボーディング：興味タグ | 興味3〜10個選択 | PG-05 | PG-07 |
| PG-07 | オンボーディング：写真 | 最大5枚登録（任意） | PG-06 | PG-08 |
| PG-08 | オンボーディング：IGハンドル | ハンドル登録（任意） | PG-07 | PG-09 |
| PG-09 | オンボーディング完了 | 成功体験と次アクション | PG-08 | ホーム |
| PG-10 | ホーム | 1日の起点・おすすめ提示 | タブ / 起動 | 各ページ |
| PG-20 | コミュニティ一覧 | 区×興味の発見 | タブ / ホーム | PG-21 |
| PG-21 | コミュニティ詳細 | 参加/退出、プレビュー | PG-20 | 探索 |
| PG-30 | 探索（スワイプ） | 友達候補の発見 | タブ / コミュニティ | PG-31 / PG-32 |
| PG-31 | プロフィール詳細（他者） | 判断材料の提供 | PG-30 | Like/Skip / 通報・ブロック |
| PG-32 | マッチ成立シート | IGハンドル解錠・深いリンク | PG-30相互同意 | Instagram外部 / PG-33 |
| PG-33 | マッチ一覧 | 成立済み相手管理 | タブ / 通知 | PG-32再表示 / ブロック |
| PG-40 | 検索 | コミュニティ・ユーザー検索 | ナビ右上 | PG-21 / PG-31 |
| PG-50 | 通知 | イベント通知確認 | ナビ右上 / タブ | 各対象ページ |
| PG-60 | 設定 | アカウント・プライバシー | プロフィールタブ右上 | PG-61/62/63 |
| PG-61 | プロフィール編集（自分） | 自己情報編集 | PG-60 / タブ | 保存→戻る |
| PG-62 | 安全センター | ブロック・通報履歴 | PG-60 | 該当詳細 |
| PG-63 | アカウント：削除・エクスポート | 法令対応 | PG-60 | ホーム |
| PG-90 | エラー・オフライン | 復旧と再試行 | 各ページ | 元ページ |
| PG-91 | Deep Linkハンドラ | 外部→アプリ遷移 | 通知 / URL | 対象ページ |

---

## 4. ページ詳細仕様

---

## PG-01: スプラッシュ

### 目的
セッション確認と初期化の入口を提供

### 入口・出口
- **入口**: アプリ起動
- **出口**:
  - セッション有効 → ホーム（PG-10）
  - セッション無効・初回 → ログイン（PG-02）

### UI構成
- ロゴ（中央）+ 微アニメ（フェードイン 0.5s）
- 下部に進捗インジケータ（スピナー）

### 状態
- **Loading**: セッション確認中（0.5〜2秒）
- **Error**: タイムアウト（>3秒）→ 「読み込みに失敗しました」+ 再試行ボタン

### 計測・ログ
- `app_launch`: アプリ起動

### アクセシビリティ
- VoiceOver: 「読み込み中」（進捗インジケータ）

### 受け入れ基準（AC）
- [ ] 3秒以内に遷移決定（セッション有効/無効）
- [ ] ネット不通でもUIが固まらない（タイムアウト処理）

【MAT参照：ページ定義 PG-01】

---

## PG-02: ログイン

### 目的
認証と規約同意の取得

### 入口・出口
- **入口**: PG-01
- **出口**:
  - 新規ユーザー → 年齢確認（PG-03）
  - 既存ユーザー → ホーム（PG-10）

### UI構成
- Large Title: 「ようこそ」
- ボタン:
  - 「電話番号でログイン」（Primary）
  - 「Appleでサインイン」（Secondary、Appleガイドライン準拠デザイン）
- 規約・プライバシーポリシーリンク（モーダル表示）
- 同意チェックボックス

### 入力・バリデーション
- **電話番号**:
  - フォーマット: 10〜11桁（日本国内）
  - SMSコード: 6桁数字、有効期限5分
  - 再送: 60秒クールダウン
- **Appleサインイン**:
  - トークン検証（Apple公開鍵で署名確認）

### 状態
- **Empty**: なし（初回必ずログイン画面）
- **Loading**: SMS送信中・Apple認証中（ボタンスピナー）
- **Error**:
  - SMS未到達: 「届かない場合は60秒後に再送できます」
  - コード不一致: 「コードが正しくありません」
  - 認証失敗: 「認証に失敗しました。もう一度お試しください」

### 計測・ログ
- `login_view`: ログイン画面表示
- `tap_login_phone`: 電話番号ログイン選択
- `tap_login_apple`: Appleログイン選択
- `tos_accepted`: 規約同意

### アクセシビリティ
- VoiceOver: 「電話番号でログイン、ボタン」
- Dynamic Type: ボタン文字サイズ追随
- タップ領域: ボタン44×44pt以上

### 受け入れ基準（AC）
- [ ] 規約同意チェック未ONで次へ進めない
- [ ] SMS再送は60秒クールダウン動作
- [ ] Appleサインイン失敗時も再試行可能

【MAT参照：4.1. 会員登録・認証 / ページ定義 PG-02】

---

## PG-03: 年齢確認

### 目的
18歳未満の排除（法令遵守）

### 入口・出口
- **入口**: PG-02
- **出口**:
  - 18歳以上 → オンボーディング（PG-05）
  - 18歳未満 → ブロック画面（「ご利用いただけません」）

### UI構成
- Large Title: 「年齢確認」
- 生年月日入力（DatePicker、Wheelsスタイル）
- セルフィー簡易認証（半モーダル、任意）
- 次へボタン

### 入力・バリデーション
- **生年月日**: 満18歳判定（UTC基準、ローカル時刻依存なし）
- **セルフィー**: 機械学習で年齢範囲推定（例: 16–20歳）

### 状態
- **Empty**: なし
- **Loading**: セルフィー認証中（スピナー）
- **Error**:
  - 18歳未満: 「本サービスは18歳以上が対象です。ご利用いただけません」（サポート導線）
  - セルフィー失敗: 「年齢確認に失敗しました。生年月日を確認してください」

### 計測・ログ
- `agegate_view`: 年齢確認画面表示
- `agegate_pass`: 年齢確認通過
- `agegate_fail`: 年齢確認失敗（理由: 18歳未満）

### アクセシビリティ
- VoiceOver: DatePicker「生年月日を選択してください」
- Dynamic Type: エラーメッセージのフォントサイズ追随

### 受け入れ基準（AC）
- [ ] ローカル時刻依存なし（UTC基準で満18歳判定）
- [ ] NG時メッセージ明確（サポート導線あり）

【MAT参照：4.1. 会員登録・認証 / ページ定義 PG-03】

---

## PG-05〜08: オンボーディング

### 共通仕様
- **ステッパー**: 進捗可視化（1/4 → 2/4 → 3/4 → 4/4）
- **戻る/次へ**: 入力保持（中断→再開時も復元）
- **スキップ**: 任意項目（写真・IGハンドル）はスキップ可能

---

### PG-05: 基本属性

**入力**:
- 居住区（リスト選択）
- 最寄駅（検索、前方一致、候補10件以内）
- 属性（学生 / 社会人）
- 学校名 or 勤務形態（自由入力 or 候補リスト）

**バリデーション**:
- 必須項目未入力 → 次へボタン非活性

**計測**: `onboarding_basic_done`

---

### PG-06: 興味タグ

**入力**:
- チップ群（カテゴリーごと: カフェ・サウナ・スポーツ・音楽等）
- 選択カウント表示（3〜10個）

**バリデーション**:
- 3未満 → 「最低3つ選択してください」

**計測**: `onboarding_interests_done`

**AC**:
- [ ] 選択は並び替え可能（最後に選んだ上位が優先表示）

---

### PG-07: 写真

**入力**:
- グリッド（空スロット + 追加ボタン）
- 並び替え（長押しドラッグ）

**バリデーション**:
- ファイルサイズ上限10MB
- EXIF位置情報削除（アップロード前）

**計測**: `onboarding_photos_add` / `onboarding_photos_done`

**AC**:
- [ ] 0枚でも進行可能
- [ ] 禁止コンテンツは即時警告

---

### PG-08: IGハンドル

**入力**:
- 説明テキスト: 「相互同意が成立するまで他者には表示されません」
- 入力フィールド（`@`不要のプレースホルダ）

**バリデーション**:
- 英数・アンダースコア、先頭文字制約
- 既に使用済みユーザー名の簡易チェック

**計測**: `onboarding_ig_set` / `onboarding_complete`

**AC**:
- [ ] 保存時にサーバーから暗号化フラグ受領

【MAT参照：4.2. オンボーディング／プロフィール / ページ定義 PG-05〜08】

---

## PG-10: ホーム

### 目的
1日の起点として、おすすめ・新着を提示

### 入口・出口
- **入口**: タブ / 起動
- **出口**: コミュニティ・探索・詳細各ページ

### UI構成
1. Large Title: 「ホーム」
2. ヒーロー挨拶（2〜3行）: 「こんにちは　午後も◯◯を楽しみましょう」
3. 日付 + 連続日数ピル（🔥7日連続）
4. セクションA: 速報カード（強調1枚）
5. セクションB: おすすめ（横スクロール）: 近いコミュニティ / 友達候補
6. セクション見出し右: 「すべて見る」（Body + `chevron.right`）

### 状態
- **Empty**: 「コミュニティに参加すると、友達候補が増えます」+ CTAカード
- **Loading**: スケルトン（カード形状のプレースホルダ + シマー）
- **Error**: 画面上部バナー + 再試行ボタン

### 計測・ログ
- `home_view`: ホーム画面表示
- `tap_reco_card`: おすすめカードタップ
- `tap_see_all`: すべて見るタップ

### アクセシビリティ
- VoiceOver: カード「新宿×カフェ、参加者120人、ダブルタップで詳細を開く」
- Dynamic Type: ヒーロー挨拶のフォントサイズ追随

### 受け入れ基準（AC）
- [ ] 空状態では「コミュニティ参加を促す」カード表示
- [ ] プルリフレッシュで最新データ取得

【MAT参照：ページ定義 PG-10 / デザイン定義 3.2.ホーム】

---

## PG-30: 探索（スワイプ）

### 目的
友達候補のブラウズ＆Like/Skip

### 入口・出口
- **入口**: タブ / コミュニティ詳細
- **出口**: プロフィール詳細（PG-31） / マッチ成立（PG-32）

### UI構成
- **大カード（3:4比率）**:
  - 写真スライド（最大5枚、ページネーションドット）
  - 年齢帯・属性ピル（例: 20–22歳 / 学生）
  - 興味タグ3件（チップ）
  - 自己紹介2行（省略記号）
- **下部ボタン**:
  - 左: 「スキップ」（`xmark.circle`）
  - 右: 「興味あり」（`heart.circle.fill`）
- **上部**: コミュニティ切替チップ

### ジェスチャ
- 左スワイプ → スキップ（閾値: 80pt）
- 右スワイプ → 興味あり（閾値: 80pt）
- 長押し → プロフィール詳細（PG-31）

### レート制限
- 短時間の連投Like抑制（1時間50件上限）
- 超過時: 「少し休憩しましょう。1時間後に再度お試しください」+ クールダウンタイマー

### 状態
- **Empty**: 「新しいコミュニティに参加すると、友達候補が増えます」+ 「コミュニティを探す」ボタン
- **Loading**: スケルトン（カード形状）
- **Error**: 画面上部バナー + 再試行ボタン

### 計測・ログ
- `swipe_like`: 右スワイプ
- `swipe_skip`: 左スワイプ
- `tap_like_btn`: 興味ありボタンタップ
- `deck_exhausted`: カード在庫切れ

### アクセシビリティ
- VoiceOver: カードグループ化「田中太郎、20〜22歳、学生、興味: カフェ・サウナ・写真」
- ヒント: 「左スワイプでスキップ、右スワイプで興味ありを送信します」

### 受け入れ基準（AC）
- [ ] マッチ成立時、半モーダルへ即遷移（PG-32）
- [ ] スキップ済みカードは当日再出現しない

【MAT参照：4.4. カード探索 / ページ定義 PG-30】

---

## PG-32: マッチ成立シート

### 目的
IGハンドル解錠→深いリンク

### 入口・出口
- **入口**: PG-30で相互同意
- **出口**: Instagram外部 / マッチ一覧（PG-33）

### UI構成
- **半モーダル（Medium、画面高さ50%）**:
  1. 成功アニメ（スケール 1.0 → 1.1 → 1.0、0.5s）
  2. タイトル（Title 2）: 「マッチしました！」
  3. 説明（Body）: 「Instagramでつながりますか？」
  4. 相手のIGハンドル（Headline、コピー可能）
  5. 主ボタン: 「Instagramを開く」（Primary CTA）
  6. 副ボタン: 「あとで」（Secondary）
  7. 注意文（Footnote）: 「外部アプリへ移動します」

### 外部遷移
- **深いリンク**: `instagram://user?username={handle}`
- **フォールバック**: ブラウザ `https://instagram.com/{handle}`
- **確認ダイアログ**: 「Instagramを開きます。よろしいですか？」

### 状態
- **Empty**: なし（マッチ成立時のみ表示）
- **Loading**: なし
- **Error**: ハンドル取得失敗 → 「エラーが発生しました」+ 再試行ボタン

### 計測・ログ
- `match_sheet_view`: マッチ成立シート表示
- `tap_open_instagram`: Instagramを開くボタンタップ
- `copy_ig_handle`: IGハンドルコピー

### アクセシビリティ
- VoiceOver: 「Instagramを開く、ボタン。外部アプリに移動します」
- Dynamic Type: ボタン文字サイズ追随

### 受け入れ基準（AC）
- [ ] 片方がブロックしたらボタンが無効化される
- [ ] 深いリンク遷移の事前確認ダイアログ表示
- [ ] Instagram未インストール時はブラウザにフォールバック

【MAT参照：4.5. マッチング / ページ定義 PG-32】

---

## PG-60〜63: 設定・アカウント管理

### PG-60: 設定

**UI構成**:
- リスト（グループ分け）:
  - プロフィール編集
  - 通知設定
  - 安全センター（ブロック・通報履歴）
  - データエクスポート
  - アカウント削除
  - 法的文書（利用規約・プライバシーポリシー）

**計測**: `settings_view`

**AC**:
- [ ] 主要項目は2タップ以内で到達

---

### PG-61: プロフィール編集

**UI構成**:
- セクション分割（自己紹介 / 興味タグ / 写真 / IGハンドル）
- 写真の並び替え（長押しドラッグ）
- 保存ボタン（右上）

**計測**: `profile_edit_view` / `profile_save`

**AC**:
- [ ] 保存成功トースト、失敗はバナー
- [ ] 必須フィールド未入力時は保存不可

---

### PG-62: 安全センター

**UI構成**:
- タブ: ブロック一覧 / 通報履歴
- ブロック一覧: 右スワイプで解除（確認ダイアログ）
- 通報履歴: 対応状況表示（対応中・完了）

**計測**: `safety_center_view` / `unblock_user`

**AC**:
- [ ] 解除は確認ダイアログ必須

---

### PG-63: アカウント：削除・エクスポート

**UI構成**:
- **エクスポート**:
  - 説明テキスト + 「データをエクスポート」ボタン
  - 完了後メールでリンク送付
- **削除**:
  - 警告文: 「削除すると以下のデータが失われます」（箇条書き）
  - 削除ボタン（`destructive`スタイル）
  - 2段階確認ダイアログ

**計測**: `account_export_request` / `account_delete_confirm`

**AC**:
- [ ] 削除受付後は即ログアウト、再ログイン不可表示
- [ ] エクスポートデータがJSON形式で機械可読

【MAT参照：4.8. 設定 / ページ定義 PG-60〜63】

---

## 5. Plan-MD 参照マップ

| 本文書セクション | Plan-MD 参照箇所 |
|---|---|---|
| 1. 目的 | 6.2. 画面一覧と要件 |
| 2. グローバル前提 | ページ定義 0.グローバル前提、デザイン定義 3.1 |
| 3. ページ一覧 | ページ定義全般 |
| PG-01〜03 | 4.1. 会員登録・認証、ページ定義 PG-01〜03 |
| PG-05〜09 | 4.2. オンボーディング、ページ定義 PG-05〜09 |
| PG-10 | ページ定義 PG-10、デザイン定義 3.2 |
| PG-20〜21 | 4.3. コミュニティ、ページ定義 PG-20〜21 |
| PG-30〜33 | 4.4 / 4.5、ページ定義 PG-30〜33 |
| PG-60〜63 | 4.8. 設定、ページ定義 PG-60〜63 |

---

## 6. 補足

### 6.1 更新履歴
| 日付 | 変更内容 | 担当 |
|---|---|---|
| 2025-10-20 | 初版作成 | 開発・QA |

---

**次に読むべき文書**: `0.5_デザイン定義.md`（ビジュアル・トークン詳細）
